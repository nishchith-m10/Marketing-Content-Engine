{
  "name": "Sub: Send Alert",
  "nodes": [
    {
      "parameters": {},
      "id": "start-node",
      "name": "Start",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1,
      "position": [
        928,
        736
      ]
    },
    {
      "parameters": {
        "sendTo": " nishchith.archive@gmail.com",
        "subject": "={{ $json.emoji }} [{{ $json.severity.toUpperCase() }}] Brand Infinity: {{ $json.alert_type }}",
        "message": "=<b>Alert ID:</b> {{ $json.alert_id }}<br>\n<b>Type:</b> {{ $json.alert_type }}<br>\n<b>Severity:</b> {{ $json.severity }}<br>\n<b>Time:</b> {{ $json.timestamp }}<br>\n<br>\n<b>Message:</b><br>\n{{ $json.message }}<br>\n<br>\n<b>Campaign ID:</b> {{ $json.campaign_id || 'N/A' }}<br>\n<b>Workflow ID:</b> {{ $json.workflow_id || 'N/A' }}<br>\n<br>\n<b>Context:</b><br>\n<pre>{{ JSON.stringify($json.context, null, 2) }}</pre>",
        "options": {
          "appendAttribution": false
        }
      },
      "id": "07675e47-9f2f-49cc-a3bd-83108b2b9300",
      "name": "Send Gmail Alert",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        1392,
        736
      ],
      "webhookId": "0ef6e5f9-609f-4ffb-b0b4-bf902f3d595f",
      "credentials": {
        "gmailOAuth2": {
          "id": "kThf5Npwf1zJFn9l",
          "name": "Nishchith Gmail account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// ALERT DISPATCHER\n// Sub-Workflow: Send_Alert\n// Per Manifesto - Operational Runbooks\n// ============================================\n\nconst input = $input.all()[0].json;\n\nif (!input.alert_type) throw new Error('alert_type is required');\nif (!input.message) throw new Error('message is required');\n\n// Alert types per Manifesto Failure Matrix (Section 10)\nconst validTypes = [\n  'error',      // System errors\n  'warning',    // Degraded performance\n  'info',       // Informational\n  'circuit_open', // Circuit breaker tripped\n  'zombie',     // Stuck campaign detected\n  'budget',     // Budget exceeded\n  'approval',   // Approval required\n  'success'     // Operation completed\n];\n\nconst type = input.alert_type.toLowerCase();\nif (!validTypes.includes(type)) {\n  console.warn(`Unknown alert type: ${type}. Using 'info'.`);\n}\n\n// Determine severity - all alerts go to email now\nlet severity = 'low';\nlet channels = ['email'];\n\nswitch (type) {\n  case 'error':\n  case 'circuit_open':\n    severity = 'high';\n    break;\n  case 'warning':\n  case 'zombie':\n  case 'budget':\n  case 'approval':\n    severity = 'medium';\n    break;\n  default:\n    severity = 'low';\n}\n\n// Emoji by severity\nconst emojis = {\n  high: 'üö®',\n  medium: '‚ö†Ô∏è',\n  low: '‚ÑπÔ∏è'\n};\n\nconst alert = {\n  alert_id: `alert_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n  alert_type: type,\n  severity: severity,\n  emoji: emojis[severity] || '‚ÑπÔ∏è',\n  message: input.message,\n  context: input.context || {},\n  campaign_id: input.campaign_id || null,\n  workflow_id: input.workflow_id || null,\n  timestamp: new Date().toISOString(),\n  channels: channels\n};\n\nreturn [{\n  json: alert\n}];"
      },
      "id": "529de9d4-d65e-4434-a0af-d1f64fb3ae36",
      "name": "Prepare Alert1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1152,
        736
      ]
    },
    {
      "parameters": {
        "jsCode": "// Prepare log entry\nconst alert = $('Prepare Alert1').first().json;\n\nreturn [{\n  json: {\n    workflow_id: alert.workflow_id || 'send_alert',\n    execution_id: alert.alert_id,\n    step_name: 'alert_dispatched',\n    status: 'completed',\n    details: {\n      alert_type: alert.alert_type,\n      severity: alert.severity,\n      message: alert.message,\n      channels: alert.channels,\n      campaign_id: alert.campaign_id\n    }\n  }\n}];"
      },
      "id": "e13ba632-6660-4f6a-a30c-bdd316709411",
      "name": "Prep Log Entry1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1632,
        736
      ]
    },
    {
      "parameters": {
        "tableId": "execution_logs",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "workflow_id",
              "fieldValue": "={{ $json.workflow_id }}"
            },
            {
              "fieldId": "execution_id",
              "fieldValue": "={{ $json.execution_id }}"
            },
            {
              "fieldId": "step_name",
              "fieldValue": "={{ $json.step_name }}"
            },
            {
              "fieldId": "status",
              "fieldValue": "={{ $json.status }}"
            },
            {
              "fieldId": "details",
              "fieldValue": "={{ $json.details }}"
            }
          ]
        }
      },
      "id": "64132550-ae75-4fbc-8af5-32f7dc82410a",
      "name": "Log Alert to DB1",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1872,
        736
      ],
      "credentials": {
        "supabaseApi": {
          "id": "ChWvV6najCTQ4JEQ",
          "name": "Brand Infinity"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Return final result\nconst alert = $('Prepare Alert1').first().json;\n\nreturn [{\n  json: {\n    success: true,\n    alert_id: alert.alert_id,\n    alert_type: alert.alert_type,\n    severity: alert.severity,\n    channels_notified: alert.channels,\n    message: 'Alert dispatched successfully'\n  }\n}];"
      },
      "id": "11a24998-4b18-41f2-bcd0-e9cdb43b3866",
      "name": "Return Result1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2112,
        736
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "Should-Slack": {
      "main": [
        [
          {
            "node": "Build Slack Message",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Should Email?": {
      "main": [
        [
          {
            "node": "Send Email Alert",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Start": {
      "main": [
        [
          {
            "node": "Prepare Alert1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Gmail Alert": {
      "main": [
        [
          {
            "node": "Prep Log Entry1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Alert1": {
      "main": [
        [
          {
            "node": "Send Gmail Alert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Log Entry1": {
      "main": [
        [
          {
            "node": "Log Alert to DB1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Alert to DB1": {
      "main": [
        [
          {
            "node": "Return Result1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "versionId": "bd11a4b8-dbf6-4bf3-bf1f-6b6833e1abff",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "fb0f3042150127121074617aaee31b106c313805cbc452132240d35f72eba898"
  },
  "id": "uCTePCAfvuecs7La",
  "tags": [
    {
      "updatedAt": "2025-12-23T09:40:14.135Z",
      "createdAt": "2025-12-23T09:40:14.135Z",
      "id": "ak5oOECQqNIPSE0N",
      "name": "Brand Infinity Engine"
    }
  ]
}